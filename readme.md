# Weather collector
Сервис для периодического сбора погоды в нескольких городах с openweathermap.

## Описание
При первом запуске приложение считывает список городов из app/cities.txt и заносит их в базу.

Далее производится определение местоположения загруженных городов.

Затем происходит первый сбор данных, последующие выполняются с периодом в 1 час.

### Использованные библиотеки и технологии

#### PostgreSQL
Быстрая и современная база данных.

#### Python 3.11

#### sqlalchemy
Удобная orm-библиотека для взаимодействия с базой данных.

Достаточно хорошо документирована, широко применяется большим количеством разработчиков и компаний.

#### alembic
Средство для управления схемой бд (создание, применение и откат миграций)

#### asyncio

#### httpx
Асинхронная библиотека для выполнения http-запросов с requests-like интерфейсом.

Активно разрабатывается, так как очень похожа на requests, легко использовать и понимать код с её применением.

#### asyncpg
Драйвер для PostgreSQL, асинхронный и быстрый.

### Подробное описание
Сервис работает в docker-контейнерах.

1. weather_collector - приложение.
2. db - postgresql-контейнер.

При первом запуске приложение пытается найти города в базе.

Если не находит, пытается загрузить из текстового файла, как описано выше.

В данном репозитории этот файл содержит список из 50 крупнейших городов мира (список спарсен [отсюда](http://www.statdata.ru/largestcities_world))

После загрузки городов из базы или из файла приложение обнаруживает города с неопределённым местоположением и пытается определить его средствами openweathermap.

Если определить местоположение не удаётся, проблемные города помечаются и больше не обрабатываются (в таком случае местоположение необходимо задать вручную).

После обработки городов на основе даты предыдущего сбора вычисляется время следующего сбора погоды.

Если последний сбор выполнялся более часа назад или данных о погоде в базе нет, сбор начинается сразу после запуска.

В ином случае сбор погоды откладывается на время, на 1 час опережающее время последнего сбора.


## Как запустить
Скопировать ".env.template" в ".env"

Задать значения переменных окружения в ".env".

`POSTGRES_DB` - название базы данных.

`POSTGRES_USER` - имя пользователя базы.

`POSTGRES_PASSWORD` - пароль пользователя базы.

`DB_URL` - URL базы, передаваемый в engine sqlalchemy, вероятно, вам не нужно его менять.

`API_KEY` - api-ключ от openweathermap.

`API_AMOUNT` и `API_PERIOD` - максимально допустимое количество запросов и период, за который можно выполнить такое количество запросов.

Задавайте на основе вашего плана, для бесплатного это не более 60 запросов за 60 секунд (эти значения указаны по умолчанию).

После заполнения .env запустите compose

`docker compose up -d`

## Описание бд
В базе данных создаются следующие таблицы:

1. city, таблица для хранения городов.
2. location, таблица для хранения местоположений городов.
3. weather, таблица для хранения информации о погоде конкретного города в конкретный момент времени.

У городов, местоположение которых определить не удалось, значение столбца location_detection_failed становится равным true.

Для исправления таких городов нужно определить местоположение вручную, добавить строку в таблицу location, связать location с городом и переключить location_detection_failed в false.

### Причина выбора
Такая структура показалась мне удобной и расширяемой, например, достаточно легко можно добавить иной вид населённых пунктов, переиспользовать местоположения при необходимости и т.п.

Если, например, широту и долготу хранить в таблице городов, внести подобные изменения будет сложнее.


### Известные проблемы и ограничения
При запуске в docker compose необходимо выполнять миграции, а затем запускать приложение.

Если сделать это инструкцией CMD, процесс не получит pid 1, не сможет получать сигналы и будет тормозить остановку проекта.

Если использовать exec-синтаксис, невозможно выполнить более одной команды.

Поэтому сейчас применён костыль с выполнением `alembic upgrade head` через os.system.

Нужно либо написать bash-скрипт, способный перехватить и перенаправить SIGTERM, либо вызывать alembic более изящно (програмно).

Воркеры, собирающие погоду, не защищены от падения, если что-то сломается, приложение просто заморозится в процессе сбора погоды.

Код не отформатирован по PEP8.
